---
title: "Final Report "
subtitle: "I-590 Applied Data Science"
author: "Bob Palmer"
date: "March 24, 2019"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE,warning=FALSE) #turn off echo as a default
library(ggplot2)
library(kableExtra)
library(dplyr)
library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
options(scipen=999)   #turn off scipen=999 scientific notation or back on scipen=0
```



```{r, echo=FALSE}
# reading in the csv file
data <- read.csv("gapminder.csv", stringsAsFactors = FALSE) # keeps strings, not factors
data$population <- as.numeric(gsub(",", "", data$population)) #remove commas from the thousands indicator in numbers
uniqueCountry <- length(unique(data$Country))

missing <- data[which(is.na(data[,5])),]
uniqueMissing <- length(unique(missing$Country))


```


## I. The Data. 

This report is based on the gapminder data file available from Gapminder.org. For each of `r uniqueCountry` countries, the data provides values for life expectancy, GDP income per capita, and population, every year for most countries from 1800 to 2015, with some for the years 1970 to 2015. Countries are identified by region: South Asia, Middle East & North Africa, Sub-Saharan Africa, Europe & Central Asia, and America. 


Here is a sample of the data set from the five regions:


```{r echo = FALSE, results = 'asis', fig.height=6, fig.width=10}

kable(data[c(1,109,216,433,541,648,911,1019,1126,4788,4896,5003,13723,13831,13938), 1:6]) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```



##II. Questions to Ask 

Interesting questions that we can ask about this data set include:

a. Which region has the highest median life expectancy and which has the lowest?

b. Which region has the highest median per capita GDP income and which has the lowest?

c. How does life expectancy change over time for the regions?

d. How does income change over time for the regions?

e. Is income a predictor of life expectancy?

f. Is  region a predictor of life expectancy?

##III. Description & Exploration of the Data 

```{r}
#(An overall narrative summary of data: how many observations, variables, type of variables, missing #values if any)
```


A summary view of data file shows 41,284 observations of 6 variables: Country,Year, life (expectancy), population, income, and region. 

An interesting statistic in this summary is that the mean life expectancy for all humans in all countries in the world for all of the years sampled is 42.88 years. 

We can also see that there are 2,341 missing values in the income column. those missing income values area from `r uniqueMissing ` countries. 


```{r}
summary(data)

```


```{r}
#- provide insights from data.-60 pts
#- exploratory plots (histogram, correlation plot, box plot)  - 20
```

Here is a histogram of the incomes for all countries for all years in the data set: 

```{r}
df <- select(filter(data, income <= 100000),c(income,population))
Income <- df$income
hist.data = hist(Income, plot=F)

plot(hist.data, col = 'blue' )

```

It seems clear from this that income per capita for all countires for all years in the data is definitely not in a gaussian (normal) distribution, but somewhat predictably it looks to be an inverse Pareto distribution, showing the predominance of low incomes in a very large part of the population, and a long thin tail of high incomes. The largest bin of income is at or below 5,000 international dollars. This sharp fall-off of income still makes this hard to visualize, so let's look at the frequency counts in a logarithmic transformation (in this case, log 2).

```{r}
df <- select(filter(data, income <= 100000),c(income,population))
Income <- df$income
hist.data = hist(Income, plot=F)
hist.data$counts = log(hist.data$counts, 2)
plot(hist.data, col = 'blue' )

```

The fact that there are many more poor countries seems intuitive, but later we will see if that changes over the years of the study.   

####Question a) Which region has the highest median life expectancy and which has the lowest?

To answer this question, We explore the data graphically, by aggregating the median life expectancy for each region, and then showing the regions on a box chart. From this chart we can see that the Middle East & North Africa, South Asia and Sub-Saharan Africa regions all have a median life expectancy in the mid 32 years. Europe & Central Asia region has the highest median life expectancy of roughly 41 and three quarter years. (The median values are labeled on the chart in red.) We see that the first quartile of life expectancy for Europe is actually higher than the median (second quartile) of all of the other regions -- in other words the whole interquartile range of Europe is above the median of all the other regions.

```{r, echo=FALSE}
#First, we calculate the region mean life expectancy with aggregate, so we can print it on the boxplot:

medianLife <- aggregate(life ~  region, data, median)

```

```{r, echo=FALSE, fig.height=6, fig.width=8}



ggplot(data, aes(x = region, y = life)) + 
  xlab('') +
  ylab('Life Expectancy') +
  theme(axis.title.x=element_text(angle=0, color='black', size = 16), axis.title.y=element_text(angle=90, color='black', face='bold', size=14)) +
  geom_boxplot(outlier.colour = "grey") + 
  theme(axis.text.x = element_text(angle = 60, size = 12, color = "blue", hjust = 1)) +    theme(axis.text.y = element_text(angle = 90, size = 16, color = "black", hjust = 1)) +   geom_text(data = medianLife, aes(label = round(life, digits = 2), y = life + 3), size = 4, colour = "red")
  
```

####Question b) Which region has the highest median per capita GDP income and which has the lowest?

To answer this, We again build a boxplot by region, by aggregating the median income for each region, and again, the medians are labeled in red. (The extreme outliers in income have been removed for clarity, but the interquartile ranges were not affected by the method.) 

We can see that Europe & Central Asia again is the leader with the highest median income. Sub-Saharan Africa is the lowest median income. 



```{r, echo=FALSE, fig.height=6, fig.width=8}
#First, we calculate the region mean income with aggregate, so we can print it on the boxplot:
medianIncome <- aggregate(income ~ region, data, median)

ggplot(data, aes(x = region, y = income)) + 
  xlab('') +
  ylab('Income Per Capita') +
  theme(axis.title.x=element_text(angle=0, color='black', size = 16), axis.title.y=element_text(angle=90, color='black', face='bold', size=14)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim = c(0, 15000)) +
    theme(axis.text.x = element_text(angle = 60, size = 12, color = "blue", hjust = 1)) +      theme(axis.text.y = element_text(angle = 90, size = 16, color = "black", hjust = 1)) +   geom_text(data = medianIncome, aes(label = income, y = income + 600), size = 4, colour = "red") 
  
  
```

From the last two figures, we may hypothesize that there is a correlation between a region's per capita income and life expectancy. 

####Question c) How does life expectancy change over time for the regions?

From the scatter plots below, we clearly see that beginning around the 1925-1950, all of the regions show a general trend of increasing life expectancy. We could hypothesize that this is due to increasing nutrition (perhaps driven by artificial nitrogen fertilizers introduced during that period) and increases in the efficacy of medical treatments.


```{r, echo=FALSE, fig.height=6, fig.width=10}

#to see the life expectancy over time across different regions
ggplot(data) + 
  geom_point(aes(x=Year, y=life), alpha = 1/10) +
  xlab('Year') +
  ylab('Life Expectancy') +
  theme(axis.title.x=element_text(angle=0, color='black', size = 14),   axis.title.y=element_text(angle=90, color='black', face='bold', size=14)) +
  facet_wrap(~region) + 
  theme(strip.text.x = element_text(size = 12, colour = "blue"), axis.text=element_text(size=12), axis.title=element_text(size=12,face="bold")) 
```

#### Question d) How does income change over time for the regions?

We can see some interesting changes; East Asia and the Pacific had some marked increases in income in the post WWII era (perhaps driven by the resergence in manufacturing in Asian countries). We can also see an explosion in income in the Middle East after the discovery and exploitation of petroleum that occurred in the post-war time period. 

```{r, echo=FALSE, fig.height=6, fig.width=10}
#to see the income over time across different regions
ggplot(data) + 
  geom_point(aes(x=Year, y=income), alpha = 1/10) +
  xlab('Year') +
  ylab('Income per Capita') +
  theme(axis.title.x=element_text(angle=0, color='black', size = 14),   axis.title.y=element_text(angle=90, color='black', face='bold', size=14)) +
  facet_wrap(~region) + 
  theme(strip.text.x = element_text(size = 12, colour = "blue"), axis.text=element_text(size=12), axis.title=element_text(size=12,face="bold")) 
```

####Question e) Is income a predictor of life expectancy?

First let's look at the raw data for all years and regions.

```{r echo=FALSE, fig.height=6, fig.width=10}

# Simple Scatterplot
library(imputeTS)
income <- data$income
#replace na with mean of the vector
income <- na.mean(income)

plot(income, data$life, xlab="Income ", ylab="Life Expectancy", pch=19, col = rgb(red = 0, green = 0, blue = 0, alpha = 0.1))



```


Here is the same correlation for the year 2000 data only:

```{r echo=FALSE, fig.height=6, fig.width=10}

options(scipen=999)   #turn off scientific notation for income
income2000 <- subset(data, Year == 2000, select = c("income","life"))

plot(income2000$income, income2000$life, xlab="Income ", ylab="Life Expectancy", pch=19)


```
Here is income and life expectancy for the regions seperately:

```{r, echo=FALSE, fig.height=6, fig.width=10}
#to see the income over time across different regions
ggplot(data) + 
  geom_point(aes(x=income, y=life), alpha = 1/10) +
  xlab('Income per Capita') +
  ylab('Life Expectancy') +
  theme(axis.title.x=element_text(angle=0, color='black', size = 14),   axis.title.y=element_text(angle=90, color='black', face='bold', size=14)) +
   facet_wrap(~region) + 
  theme(strip.text.x = element_text(size = 12, colour = "blue"), axis.text=element_text(size=12), axis.title=element_text(size=12,face="bold")) 
  
```


```{r}
#- regression analysis - 20
#Note: If you do not describe your analysis, if it will not count toward points. For example, if you #create a histogram but do not provide any explanation of the figure -  it will not be included

```

#### Linear Regression Analysis

To further examine question e) Is income a predictor of life expectancy?, let's do a linear regression analysis on the data. Simple linear regression is a statistical method that allows us to summarize and study relationships between two quantitative variables; in this case the predictor variable is income (x axis), and the response variable is life expectancy (y axis).

The slope of the regression lines tell us that we can infer that as income goes up, life expectancy increases. 

(We have also changed the income axis to a logarithmic view to make the data easier to visualize.) 



```{r, echo=FALSE, fig.height=6, fig.width=10, warning=FALSE}
#to see the income over time across different regions
ggplot(data, aes(x=log(income,2), y=life), alpha = 1/10) + 
  geom_point(alpha = 1/10 ) +
  xlab('Income per Capita') +
  ylab('Life Expectancy') +
  theme(axis.title.x=element_text(angle=0, color='black', size = 14),   axis.title.y=element_text(angle=90, color='black', face='bold', size=14)) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  facet_wrap(~region) + 
  theme(strip.text.x = element_text(size = 12, colour = "blue"), axis.text=element_text(size=12), axis.title=element_text(size=12,face="bold")) 
```

####Question f) Is  region a predictor of life expectancy?

If region is a predictor of life expectancy, then we could assume that a cluster analysis of the metrics (population, income, life expectancy) of each country would group them in clusters that are similar to their geograpic regions. 



###Cluster Analysis

```{r}
#- cluster analysis - 20

#Note: If you do not describe your analysis, if it will not count toward points. For example, if you #create a histogram but do not provide any explanation of the figure -  it will not be included
```


```{r message=FALSE, warning=FALSE}
library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
```



Cluster Analysis is a form of exploratory data analysis (EDA) where observations are divided into meaningful groups that share common characteristics (features).

```{r}
###Read in dataset for clustering
df <- read.csv('gapminder.csv')

df <- data[df$Year == '2015',] # filter the data df for only one year data, 

df$population <- as.numeric(gsub(",", "", df$population)) #remove commas from the thousands indicator in numbers

df <- na.omit(df)#Remove missing values

rownames(df) <- df$Country #The industry name will be on the cluster plot instead of row numbers.

dfXindia <- subset(df, Country!="India") # remove india from dataset

dfXindia <- subset(dfXindia, Country!="China") # remove china from dataset

df <- df[, c(3,4,5)] #select only life, population, and income
dfXindia <- dfXindia[, c(3,4,5)] #select only life, population, and income

dat <- scale(df)
datXindia <- scale(dfXindia)

```



```{r}
#function for plotting elbow
wss <- function(k) {
kmeans(df, k, nstart = 10)$tot.withinss
}

k.values <- 1:15

wss_values <- map_dbl(k.values, wss)
```

In order to decide how many clusters to use in our analysis, we can use a so-called elbow chart, which measures the distances differentiating the members of the clusters for different numbers of clusters. 

```{r}
#visualizing the elbow chart
plot(k.values, wss_values, type = "b", pch = 19, frame = FALSE, xlab = "Num of Clusters", ylab="Tot within-clust sum-of-squares")
```

We see that three is a good "elbow point" for selecting the number of clusters to use in our analysis.

However, in the figure below, we see that two outlier countries, India and China are in their own cluster alone. This could be because India and china have an order of magnitude higher population than all other countries in the data set. 


```{r, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE}
#visualiziation
k2 <- kmeans(dat, centers = 3, nstart = 25)
visual<- fviz_cluster(k2, data = dat)
visual
```
So let's see the clusters without the two outlier countries: 



```{r, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE}
# visualization ex-India
k2Xindia <- kmeans(datXindia, centers = 3, nstart = 25)
visualXindia<- fviz_cluster(k2Xindia, data = datXindia)
visualXindia
```

We see that the countries are clustered in such a way that they do not reflect their geographic regions in the clusters. This would not give us enough evidence to support the hypothesis that region is determitive of life expectancy. 

##IV. Findings 
```{r}
# make sure to provide answers to questions you have generated at the beginning. Write a brief #summary of your answers in your report. You are not expected to have a comprehensive research in #this assignment. 10pts

#6. Use of RMarkdown or Python notebook - 5 pts [proper syntax, documentation, output] Use code #chunks and also in-line #code, header, fonts, title etc
```


To review, here are the six questions we sought to answer with this report. 

 <span style="color:blue">a. Which region has the highest median life expectancy and which has the lowest?</span>

Using the box plots, we discovered that Europe & Central Asia has the hightest median life expectancy, and Middle East & North Africa has the lowest. 

<span style="color:blue">b. Which region has the highest median per capita GDP income and which has the lowest?</span>

We found that Europe & Central Asia has the hightest median income, and Sub-Saharan Africa has the lowest.

<span style="color:blue">c. How does life expectancy change over time for the regions?</span>

The faceted scatter plots for the regions indicated that ll of the regions show a general trend of increasing life expectancy. We could hypothesize that this is due to increasing nutrition (perhaps driven by artificial nitrogen fertilizers introduced during that period) and increases in the efficacy of medical treatments. Data could be found for those observations and that analysis could be the topic of future analysis. 

<span style="color:blue">d. How does income change over time for the regions?</span>

All of the regions had increases in income over the years recorded. East Asia & Pacific had some marked increases in income in the post WWII era (perhaps driven by the resergence in manufacturing in Asian countries). We can also see an explosion in income in the Middle East after the discovery and exploitation of petroleum that occurred in the post-war time period. South Asia and Sub-Saharan Africa regionis did not indicate as large of an increase.

<span style="color:blue">e. Is income a predictor of life expectancy?</span>

Our linear regression analysis showed that for all of the regions as income increased so did life expectancy. 

<span style="color:blue">f. Is  region a predictor of life expectancy?</span>

Our hypothesis was that if region where a predictor of life expectancy, then we could assume that a cluster analysis of the metrics (population, income, life expectancy) of each country would group them in clusters that are similar to their geograpic regions.  But, this clustering was not upheld by the results. Therefore we do not have sufficient evidence from the data to say that region is determinative of life expectancy. 








